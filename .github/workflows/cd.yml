name: CD Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - master

env:
  DOTNET_VERSION: "9.0.x"
  PROJECT_PATH: "BPCalculator/BPCalculator.csproj"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name:  Checkout Code
      uses: actions/checkout@v4

    - name:  Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name:  Restore
      run: dotnet restore

    - name:  Build App
      run: dotnet build --configuration Release

    - name:  Publish Artifact
      run: dotnet publish -c Release -o published

    - name:  Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app
        path: published/

  deploy_qa:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name:  Download App Package
      uses: actions/download-artifact@v4
      with:
        name: app
        path: published

    # Deploy to QA slot using publish profile
    - name:  Deploy to QA Slot
      uses: azure/webapps-deploy@v3
      with:
        app-name: "bp-qa-webapp"
        publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_QA }}
        package: published

    # Install Chrome
    - name:  Install Chrome
      uses: browser-actions/setup-chrome@v1

    # Install ChromeDriver
    - name:  Install ChromeDriver
      uses: nanasess/setup-chromedriver@v2

    # Run Selenium Tests against QA Slot
    - name:  Run Selenium E2E Tests
      env:
        BP_E2E_BASEURL: "https://bp-qa-webapp.azurewebsites.net"
      run: |
        echo "Running Selenium tests..."
        dotnet test BPCalculator.E2ETests/BPCalculator.E2ETests.csproj

    # Run k6 Performance Test
    - name:  Run k6 Performance Test
      uses: grafana/k6-action@v0.3.1
      with:
        filename: perf/k6-bp-smoke.js
      env:
        TARGET_URL: "https://bp-qa-webapp.azurewebsites.net"

  promote_to_staging:
    needs: deploy_qa
    runs-on: ubuntu-latest

    steps:
    - name:  Swap QA â†’ Staging
      uses: azure/CLI@v2
      with:
        inlineScript: |
          az webapp deployment slot swap \
            --name bp-staging-webapp \
            --resource-group rg-bp-calculator \
            --slot qa \
            --target-slot staging

  test_staging:
    needs: promote_to_staging
    runs-on: ubuntu-latest

    steps:
    - name:  Install Chrome
      uses: browser-actions/setup-chrome@v1

    - name:  Install ChromeDriver
      uses: nanasess/setup-chromedriver@v2

    - name:  Run Selenium on Staging
      env:
        BP_E2E_BASEURL: "https://bp-staging-webapp.azurewebsites.net"
      run: |
        dotnet test BPCalculator.E2ETests/BPCalculator.E2ETests.csproj

  approve_for_prod:
    needs: test_staging
    runs-on: ubuntu-latest

    steps:
    - name:  Manual Approval Required
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ secrets.GITHUB_TOKEN }}
        approvers: harshith

  deploy_prod:
    needs: approve_for_prod
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ”„ Swap Staging â†’ Production
      uses: azure/CLI@v2
      with:
        inlineScript: |
          az webapp deployment slot swap \
            --name bp-prod-webapp \
            --resource-group rg-bp-calculator \
            --slot staging \
            --target-slot production

    - name:  Deployment Successful
      run: echo "Production deployment completed!"
