name: CD Pipeline

on:
  push:
    branches: ["develop"]

jobs:

  # 1) Deploy to QA Environment

  deploy_qa:
    name: Deploy to QA
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Download Build Artifact
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: ./app

    # Azure Web App QA deployment
    - name: Deploy to Azure Web App (QA)
      uses: azure/webapps-deploy@v3
      with:
        app-name: "bp-webapp"
        slot-name: "qa"
        publish-profile: ${{ secrets.AZURE_PUBLISH_QA }}
        package: ./app

    #  QA Testing 

    - name: Run E2E Tests
      run: |
        echo "Running E2E tests against QA..."
        dotnet test E2E/E2E.Tests.csproj

    - name: Run Performance Tests (k6)
      run: |
        echo "Running k6 load tests"
        k6 run performance-tests/bp_load_test.js

    - name: Run OWASP ZAP (DAST)
      uses: zaproxy/action-full-scan@v0.10.0
      with:
        target: "https://bp-webapp-qa.azurewebsites.net"

    - name: QA Environment Gate
      if: failure()
      run: |
        echo "QA Tests Failed. Stopping Release."
        exit 1

  
  # 2) Promote to Pre-Prod

  deploy_preprod:
    name: Deploy to Pre-Prod
    runs-on: ubuntu-latest
    needs: deploy_qa

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Download Build Artifact
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: ./app

    - name: Deploy to Azure Web App (Pre-prod)
      uses: azure/webapps-deploy@v3
      with:
        app-name: "bp-webapp"
        slot-name: "preprod"
        publish-profile: ${{ secrets.AZURE_PUBLISH_PREPROD }}
        package: ./app

    - name: Smoke Tests
      run: |
        echo "Running smoke tests..."
        curl -I https://bp-webapp-preprod.azurewebsites.net

    - name: Pre-Prod Gate
      if: failure()
      run: |
        echo "Pre-Prod Verification Failed!"
        exit 1


  # 3) Blue–Green Deployment to Production

  deploy_prod:
    name: Blue-Green to Production
    runs-on: ubuntu-latest
    needs: deploy_preprod

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Download Build Artifact
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: ./app

    # Deploy to Staging Slot
    - name: Deploy to Staging Slot
      uses: azure/webapps-deploy@v3
      with:
        app-name: "bp-webapp"
        slot-name: "staging"
        publish-profile: ${{ secrets.AZURE_PUBLISH_STAGING }}
        package: ./app

    # Test in staging before final swap
    - name: Test Staging Slot
      run: |
        echo "Health check..."
        curl -I https://bp-webapp-staging.azurewebsites.net

    - name: OWASP ZAP Quick Scan
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: "https://bp-webapp-staging.azurewebsites.net"

    # Blue–Green Swap
    - name: Swap Staging to Production
      uses: azure/cli@v2
      with:
        inlineScript: |
          az webapp deployment slot swap \
            --name bp-webapp \
            --resource-group YOUR_RESOURCE_GROUP \
            --slot staging \
            --target-slot production

    - name: Deployment Complete
      run: echo "Blue–Green Deployment to Production Successful!"
