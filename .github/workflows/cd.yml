name: CD Pipeline

on:
  push:
    branches: ["master"]          # Only deploy when master is updated

jobs:
  #################################################################
  # 1) Build & publish the app ONCE and store as an artifact
  #################################################################
  build_and_package:
    name: Build and Publish App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Publish web app
        run: dotnet publish BPCalculator/BPCalculator.csproj -c Release -o ./publish --no-build

      - name: Upload publish folder as artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-publish
          path: ./publish

  #################################################################
  # 2) Deploy to QA and run Selenium E2E tests
  #################################################################
  deploy_qa:
    name: Deploy to QA and run E2E
    runs-on: ubuntu-latest
    needs: build_and_package
    environment:
      name: qa
      url: https://bp-qa-webapp.azurewebsites.net

    steps:
      - name: Download published app
        uses: actions/download-artifact@v4
        with:
          name: app-publish
          path: ./publish

      - name: Deploy to QA Web App (publish profile)
        uses: azure/webapps-deploy@v3
        with:
          app-name: "bp-qa-webapp"
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_QA }}
          package: "./publish"

      # ---------- Selenium E2E ----------
      - name: Checkout repository (for test projects)
        uses: actions/checkout@v4

      - name: Setup .NET for tests
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Run Selenium E2E tests against QA URL
        env:
          APP_URL: "https://bp-qa-webapp.azurewebsites.net"
        run: |
          echo "Running Selenium E2E tests against $APP_URL ..."
          dotnet test BPCalculator.E2ETests/BPCalculator.E2ETests.csproj \
            --configuration Release

  #################################################################
  # 3) Deploy to Pre-Prod (staging app) + k6 perf + OWASP ZAP
  #################################################################
  deploy_staging:
    name: Deploy to Pre-Prod (staging app) and run perf + ZAP
    runs-on: ubuntu-latest
    needs: deploy_qa
    environment:
      name: preprod
      url: https://bp-staging-webapp.azurewebsites.net

    steps:
      - name: Download published app
        uses: actions/download-artifact@v4
        with:
          name: app-publish
          path: ./publish

      - name: Deploy to Staging Web App (Pre-Prod)
        uses: azure/webapps-deploy@v3
        with:
          app-name: "bp-staging-webapp"
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_STAGING }}
          package: "./publish"

      # ---------- k6 performance tests ----------
      - name: Install k6
        run: |
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Run k6 performance tests
        env:
          TARGET_URL: "https://bp-staging-webapp.azurewebsites.net"
        run: |
          echo "Running k6 performance tests against $TARGET_URL ..."
          k6 run perf/k6-bp-smoke.js

      # ---------- OWASP ZAP baseline scan ----------
      - name: OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: "https://bp-staging-webapp.azurewebsites.net"
        continue-on-error: true   # set to false if you want this to be a hard gate

  #################################################################
  # 4) Blue-Green style deploy to Prod using SLOT
  #    - deploy to bp-prod-webapp "staging" slot with publish profile
  #    - then simple smoke check on slot
  #    - manual swap in Portal gives you Blue/Green
  #################################################################
  deploy_prod:
    name: Deploy to Prod STAGING slot (Blue-Green)
    runs-on: ubuntu-latest
    needs: deploy_staging
    environment:
      name: production
      url: https://bp-prod-webapp.azurewebsites.net

    steps:
      - name: Download published app
        uses: actions/download-artifact@v4
        with:
          name: app-publish
          path: ./publish

      - name: Deploy to Production 'staging' slot
        uses: azure/webapps-deploy@v3
        with:
          app-name: "bp-prod-webapp"
          slot-name: "staging"
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_PROD }}
          package: "./publish"

      - name: Smoke test on prod staging slot
        run: |
          echo "Checking prod staging slot health..."
          curl -I https://bp-prod-webapp-staging.azurewebsites.net || exit 1

