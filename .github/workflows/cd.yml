name: CD Pipeline

on:
  push:
    branches: ["master"]      # Only deploy when master is updated

jobs:

  # 1) Build & Package once

  build_and_package:
    name: Build and Publish App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release

      - name: Publish web app
        run: dotnet publish BPCalculator/BPCalculator.csproj -c Release -o ./publish

      - name: Upload publish folder as artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-publish
          path: ./publish

  # 2) Deploy to QA + Selenium E2E
  
  deploy_qa:
    name: Deploy to QA and run E2E
    runs-on: ubuntu-latest
    needs: build_and_package
    environment:
      name: qa
      url: https://bp-qa-webapp.azurewebsites.net

    steps:
      - name: Download published app
        uses: actions/download-artifact@v4
        with:
          name: app-publish
          path: ./publish

      - name: Deploy to QA Web App (publish profile)
        uses: azure/webapps-deploy@v3
        with:
          app-name: "bp-qa-webapp"
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_QA }}
          package: "./publish"

      # Selenium E2E tests (template â€“ adjust project path as you create it)
      - name: Setup .NET for tests
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Run Selenium E2E tests against QA URL
        env:
          APP_URL: "https://bp-qa-webapp.azurewebsites.net"
        run: |
          echo "Running Selenium E2E tests..."
          dotnet test BPCalculator.E2ETests/BPCalculator.E2ETests.csproj --logger trx

  
  # 3) Deploy to Staging/Pre-Prod + k6+ZAP
  
  deploy_staging:
    name: Deploy to Pre-Prod (staging app) and run perf + ZAP
    runs-on: ubuntu-latest
    needs: deploy_qa
    environment:
      name: preprod
      url: https://bp-staging-webapp.azurewebsites.net

    steps:
      - name: Download published app
        uses: actions/download-artifact@v4
        with:
          name: app-publish
          path: ./publish

      - name: Deploy to Staging Web App (Pre-Prod)
        uses: azure/webapps-deploy@v3
        with:
          app-name: "bp-staging-webapp"
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_STAGING }}
          package: "./publish"

      # k6 performance test (template)
      - name: Install k6
        run: |
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Run k6 performance tests
        env:
          TARGET_URL: "https://bp-staging-webapp.azurewebsites.net"
        run: |
          echo "Running k6 performance tests..."
          k6 run perf/bp_perftest.js

      # OWASP ZAP baseline scan against Pre-Prod
      - name: OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: "https://bp-staging-webapp.azurewebsites.net"
        continue-on-error: true   # for demo; set to false to make it a hard gate

  
  # 4) Deploy to Prod (Blue-Green style via slot)

  deploy_prod:
    name: Deploy to Prod Staging Slot (Blue-Green)
    runs-on: ubuntu-latest
    needs: deploy_staging
    environment:
      name: production
      url: https://bp-prod-webapp.azurewebsites.net

    steps:
      - name: Download published app
        uses: actions/download-artifact@v4
        with:
          name: app-publish
          path: ./publish

      - name: Deploy to Production 'staging' slot (Blue-Green target)
        uses: azure/webapps-deploy@v3
        with:
          app-name: "bp-prod-webapp"
          slot-name: "staging"
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_PROD }}
          package: "./publish"

      - name: Smoke test on staging slot
        run: |
          echo "Checking staging slot health..."
          curl -I https://bp-prod-webapp-staging.azurewebsites.net || exit 1

      - name: Info - Manual slot swap
        run: |
          echo "Deployment to staging slot completed."
          echo "For full blue-green release, perform a slot swap"
          echo "in the Azure Portal: staging -> production."
