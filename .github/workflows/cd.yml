name: CD Pipeline

on:
  # Deployment is only from master (your release branch)
  push:
    branches: ["master"]
  workflow_dispatch:

env:
  # URLs â€“ adjust if your slot name / region changes
  QA_URL: "https://bp-qa-webapp.azurewebsites.net"
  GREEN_URL: "https://bp-prod-webapp-green.azurewebsites.net"
  PROD_URL: "https://bp-prod-webapp.azurewebsites.net"

jobs:
  # -------------------------------------------------------------------
  # 1. Build once and publish artefact
  # -------------------------------------------------------------------
  build_webapp:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        run: dotnet restore

      - name: Publish web app
        run: dotnet publish BPCalculator/BPCalculator.csproj -c Release -o ./publish

      - name: Upload published artefact
        uses: actions/upload-artifact@v4
        with:
          name: webapp-publish
          path: ./publish

  # -------------------------------------------------------------------
  # 2. Deploy to QA and run Selenium E2E tests
  # -------------------------------------------------------------------
  deploy_qa:
    runs-on: ubuntu-latest
    needs: build_webapp
    environment: qa   # create "qa" environment in GitHub if you want approvals

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download webapp artefact
        uses: actions/download-artifact@v4
        with:
          name: webapp-publish
          path: ./publish

      - name: Deploy to QA Web App
        uses: azure/webapps-deploy@v2
        with:
          # Secret containing the *full* publish profile XML
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_QA }}
          package: ./publish

      # --- Selenium E2E tests against QA ---------------------
      - name: Setup .NET 9 for tests
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Run Selenium E2E tests against QA URL
        env:
          APP_URL: ${{ env.QA_URL }}
        run: |
          echo "Running Selenium E2E tests against $APP_URL ..."
          dotnet test BPCalculator.E2ETests/BPCalculator.E2ETests.csproj --configuration Release

  # -------------------------------------------------------------------
  # 3. Deploy to GREEN slot (pre-prod) and run k6 + ZAP
  # -------------------------------------------------------------------
  deploy_green:
    runs-on: ubuntu-latest
    needs: deploy_qa
    environment: preprod   # create "preprod" environment if desired

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download webapp artefact
        uses: actions/download-artifact@v4
        with:
          name: webapp-publish
          path: ./publish

      - name: Deploy to PROD green slot
        uses: azure/webapps-deploy@v2
        with:
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PROD_GREEN }}
          package: ./publish

      # --- k6 performance test --------------------------------
      - name: Run k6 smoke/performance tests against GREEN slot
        uses: grafana/k6-action@v0.3
        env:
          K6_WEB_DASHBOARD: "false"
          APP_URL: ${{ env.GREEN_URL }}
        with:
          filename: perf/k6-bp-smoke.js

      # --- OWASP ZAP baseline security scan -------------------
      - name: Run OWASP ZAP Baseline Scan against GREEN slot
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: ${{ env.GREEN_URL }}
          # Optional: tweak to keep scan short for pipeline
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a"

  # -------------------------------------------------------------------
  # 4. Promote to PRODUCTION (blue slot) if all checks pass
  # -------------------------------------------------------------------
  deploy_prod:
    runs-on: ubuntu-latest
    needs: deploy_green
    # Use GitHub "production" environment for manual approval gate
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download webapp artefact
        uses: actions/download-artifact@v4
        with:
          name: webapp-publish
          path: ./publish

      - name: Deploy to PROD (blue) slot
        uses: azure/webapps-deploy@v2
        with:
          # This publish profile should be for the main production slot
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PROD }}
          package: ./publish

      # Optional: quick smoke E2E against production
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Run Selenium smoke tests against PROD URL
        env:
          APP_URL: ${{ env.PROD_URL }}
        run: |
          echo "Running Selenium smoke tests against $APP_URL ..."
          dotnet test BPCalculator.E2ETests/BPCalculator.E2ETests.csproj --configuration Release \
            --filter "Category=Smoke"
