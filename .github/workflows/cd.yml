name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
  workflow_dispatch:

env:

  QA_URL: "https://bp-qa-webapp.azurewebsites.net"
  STAGING_SLOT_URL: "https://bp-prod-webapp-staging.azurewebsites.net"
  PROD_URL: "https://bp-prod-webapp.azurewebsites.net"

# 1. BUILD â€” executed once

jobs:
  build_app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        run: dotnet restore

      - name: Publish Web App
        run: dotnet publish BPCalculator/BPCalculator.csproj -c Release -o publish

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: webapp
          path: publish

# 2. DEPLOY TO QA + RUN SELENIUM E2E TESTS

deploy_qa:
  runs-on: ubuntu-latest
  needs: build_app
  environment: qa

  steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: webapp
        path: publish

    - name: Deploy to QA Web App
      uses: azure/webapps-deploy@v2
      with:
        publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_QA }}
        package: publish

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "9.0.x"

    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1

    - name: Install ChromeDriver
      uses: nanasess/setup-chromedriver@v2

    - name: Run Selenium E2E tests (QA)
      env:
        BP_E2E_BASEURL: ${{ env.QA_URL }}
      run: dotnet test BPCalculator.E2ETests/BPCalculator.E2ETests.csproj

# 3. DEPLOY TO GREEN SLOT (PRE-PROD) + PERF + SECURITY TESTS

  deploy_staging_slot:
    runs-on: ubuntu-latest
    needs: deploy_qa
    environment: preprod

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: webapp
          path: publish

      - name: Deploy to green slot (pre-prod)
        uses: azure/webapps-deploy@v2
        with:
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_STAGING }}
          package: publish

      # ------------ K6 PERFORMANCE TEST --------------------
      - name: Run k6 performance tests
        uses: grafana/k6-action@v0.3
        env:
          APP_URL: ${{ env.STAGING_SLOT_URL }}
        with:
          filename: perf/k6-bp-smoke.js

      # ------------ ZAP SECURITY SCAN ---------------------
      - name: OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: ${{ env.STAGING_SLOT_URL }}
          cmd_options: "-a"


# 4. SLOT SWAP (GREEN â†’ PROD) â€” MANUAL APPROVAL REQUIRED

  promote_to_prod:
    runs-on: ubuntu-latest
    needs: deploy_staging_slot
    environment:
      name: production   # ðŸ‘ˆ This enables manual approval
    steps:
      - name: Swap GREEN slot into PRODUCTION
        uses: azure/cli@v2
        with:
          inlineScript: |
            az webapp deployment slot swap \
              --name bp-prod-webapp \
              --resource-group bp-resource-group \
              --slot green \
              --target-slot production \
              --action swap

